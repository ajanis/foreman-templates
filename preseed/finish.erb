<%#
kind: finish
name: Preseed default finish
oses:
- Debian
- Ubuntu
%>
<%
  # safemode renderer does not support unary negation
  pm_set = @host.puppetmaster.empty? ? false : true
  puppet_enabled = pm_set || @host.params['force-puppet'] && @host.params['force-puppet'] == 'true'
  puppet4_enabled = @host.params['puppet4_enabled'] && @host.params['puppet4_enabled'] == 'true'
  salt_enabled = @host.params['salt_master'] ? true : false
  chef_enabled = @host.respond_to?(:chef_proxy) && @host.chef_proxy
  is_physical = (@host.facts['virtual'] == 'physical') ? true : false
  burnin_enabled = @host.params['burn-in'] ? @host.params['burn-in'] : is_physical
  packages_host = @host.params['packages_host'] ? @host.params['packages_host'] : "packages.#{@host.domain}"
%>

<% subnet = @host.subnet -%>
<% if subnet.respond_to?(:dhcp_boot_mode?) -%>
<%   dhcp = subnet.dhcp_boot_mode? && !@static -%>
<% else -%>
<%   dhcp = !@static -%>
<% end -%>
<% unless dhcp -%>
# host and domain name need setting as these values may have come from dhcp if pxe booting
/bin/sed -i "s/^search.*$/search <%= @host.domain %>/g" /etc/resolv.conf
/bin/sed -i "s/.*dns-search.*/\tdns-search <%= @host.domain %>/g" /etc/network/interfaces
/bin/sed -i "s/^<%= @host.ip %>.*/<%= @host.ip %>\t<%= @host.shortname %>.<%= @host.domain %>\t<%= @host.shortname %>/g" /etc/hosts
<% end -%>
<% if puppet4_enabled %>
apt-get install -y puppet-agent=1.10.12-1<%= @host.operatingsystem.release_name %>
cat > /etc/puppetlabs/puppet/puppet.conf << EOF
<%= snippet 'puppet.conf' %>
stringify_facts = false
EOF
if [ -f "/etc/default/puppet" ]
then
/bin/sed -i 's/^START=no/START=yes/' /etc/default/puppet
fi
/opt/puppetlabs/puppet/bin/puppet agent --enable
/opt/puppetlabs/puppet/bin/puppet agent --config /etc/puppetlabs/puppet/puppet.conf --onetime --configtimeout 300 --tags no_such_tag <%= @host.puppetmaster.blank? ? '' : "--server #{@host.puppetmaster}" %> --no-daemonize
<% else -%>
<%  if puppet_enabled %>
apt-get install -y puppet
cat > /etc/puppet/puppet.conf << EOF
<%= snippet 'puppet.conf' %>
stringify_facts = false
EOF
if [ -f "/etc/default/puppet" ]
then
/bin/sed -i 's/^START=no/START=yes/' /etc/default/puppet
fi
/bin/touch /etc/puppet/namespaceauth.conf
/usr/bin/puppet agent --enable
/usr/bin/puppet agent --config /etc/puppet/puppet.conf --onetime --configtimeout 300 --tags no_such_tag <%= @host.puppetmaster.blank? ? '' : "--server #{@host.puppetmaster}" %> --no-daemonize
<%  end -%>
<% end -%>

<% if @host.info['parameters']['realm'] && @host.otp && @host.realm && @host.realm.realm_type == 'FreeIPA' -%>
<%= snippet 'freeipa_register' %>
<% end -%>

<% if salt_enabled %>
cat > /etc/salt/minion << EOF
<%= snippet 'saltstack_minion' %>
EOF
# Running salt-call to trigger key signing
salt-call --no-color --grains >/dev/null
<% end -%>

<% if chef_enabled %>
<%= respond_to?(:chef_bootstrap) ? chef_bootstrap(@host) : snippet_if_exists("chef-client omnibus bootstrap") %>
<% end%>

# RG STUFF
# add fqdn as hostname
/bin/echo "<%= @host.shortname %>.<%= @host.domain %>" > /etc/hostname
## resolv.conf
cat << _EOF > /etc/resolvconf/resolv.conf.d/head
domain <%= @host.domain %>
<% [subnet.dns_primary,subnet.dns_secondary].reject{|n| n.blank?}.each do |dns_server| -%>
nameserver <%= dns_server %>
<% end -%>
options rotate
options timeout:1
_EOF

## allow root login
sed -i "s/^PermitRootLogin .*$/PermitRootLogin yes/g" /etc/ssh/sshd_config

## bind home and opt to data disk partition
mkdir -p /mnt/disk1_data/home
echo '/mnt/disk1_data/home  /home none bind,nofail 0 0' >> /etc/fstab
mkdir /mnt/disk1_data/opt
echo '/mnt/disk1_data/opt  /opt none bind,nofail 0 0' >> /etc/fstab

<% if @host.operatingsystem.name == 'Ubuntu' -%>
# xenial workaround to override default options for grub to disable splash
sed 's/GRUB_CMDLINE_LINUX_DEFAULT=".*"/GRUB_CMDLINE_LINUX_DEFAULT="nosplash net.ifnames=0 biosdevname=0 usbcore.autosuspend=-1"/g' -i /etc/default/grub && update-grub
<% if @host.operatingsystem.major.to_i >= 15 -%>
# fix puppet.service start issue on boot
mkdir -p /etc/systemd/system/puppet.service.d
cat > /etc/systemd/system/puppet.service.d/waitfornetwork.conf << EOF
[Unit]
Description=Puppet agent
Wants=network-online.target
After=network-online.target
EOF
<% end -%>
<% end -%>

## prepare bootstrap and burn-in tool
wget --no-parent -P /tmp/ http://<%= packages_host -%>/scripts/rg-burnin.sh
echo "running rg-burnin.sh" >> /bootstrap.log 2>&1
bash /tmp/rg-burnin.sh <%= packages_host %> <%= burnin_enabled -%> >> /bootstrap.log 2>&1

# Send finish to foreman
/usr/bin/wget --no-proxy --quiet --output-document=/dev/null --no-check-certificate <%= foreman_url('built') %>
